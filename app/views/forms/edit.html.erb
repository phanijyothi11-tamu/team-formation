<h1>Editing Form</h1>

<%# Display flash alert if present %>
<% if flash[:alert] %>
  <div class="alert alert-danger"><%= flash[:alert] %></div>
<% end %>

<%# Display form errors %>
<% if @form.errors.any? %>
  <div class="error-container">
    <div class="error-icon">
      <i class="fas fa-exclamation-circle"></i>
    </div>
    <div class="error-message">
      <h4>Oops! Please correct the following:</h4>
      <ul>
        <% @form.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  </div>
<% end %>

<%= form_with(model: @form, local: true, data: { turbo: false }) do |form| %>
  <div>
    <%= form.label :name %>
    <%= form.text_field :name, class: 'form-control' %>
  </div>

  <div>
    <%= form.label :description %>
    <%= form.text_area :description, class: 'form-control' %>
  </div>
  
  <%# Deadline picker %>
  <div class="field">
    <%= form.label :deadline, "Set Deadline" %>
    <%= form.datetime_local_field :deadline, id: "deadline_picker" %>
    <button type="button" onclick="setDeadline()">Save</button>
    <p id="display_deadline"></p>
  </div>

  <%# Action buttons %>
  <div class="d-flex justify-content-between align-items-center">
    <%= link_to "Back to Forms", user_path(current_user), class: "btn btn-secondary" %>
    <%= form.submit "Save Form", class: "btn btn-primary", id: "form_submit_button" %>
    <%= button_tag 'Duplicate Form', type: 'button', class: 'btn btn-secondary', onclick: "window.open('#{duplicate_form_path(@form)}', '_blank')" %>
    <%= link_to 'Upload Students', upload_form_path(@form.id), class: 'btn btn-primary' %>
  </div>
<% end %>

<h2>Current Attributes</h2>
<% if @form.form_attributes.any? %>
  <p>Total Weightage: <%= @form.form_attributes.sum(:weightage).round(1) %></p>
  <ul>
    <% @form.form_attributes.select(&:persisted?).each do |attribute| %>
      <li>
        <%= attribute.name %> (<%= attribute.field_type %>)
        <% if attribute.field_type == 'scale' %>
          (Min: <%= attribute.min_value %>, Max: <%= attribute.max_value %>)
        <% elsif attribute.field_type == 'mcq' %>
          <ul>
            <% (attribute.options&.split(',') || []).each_with_index do |option, index| %>
              <li>Option <%= index + 1 %>: <%= option %></li>
            <% end %>
          </ul>
        <% end %>
        <div>Current Weightage: <%= attribute.weightage || "Not set" %></div>
        <%= form_with(model: attribute, url: update_weightage_form_attribute_path(@form, attribute), method: :patch, local: true) do |f| %>
          <%= f.label :weightage, "Update Weightage (0.0 to 1.0)" %>
          <%= f.number_field :weightage, step: 0.1, min: 0, max: 1, value: attribute.weightage %>
          <%= f.submit "Update Weightage", class: "btn btn-primary" %>
        <% end %>
        <%= button_to 'Destroy Attribute', form_attribute_path(@form, attribute), method: :delete, data: { confirm: 'Are you sure you want to remove this question?'}, class: 'btn btn-danger'%>
      </li>
    <% end %>
  </ul>
<% else %>
  <p>No attributes added yet.</p>
<% end %>

<h2>Add Attribute</h2>
<%= form_with(model: [@form, @form.form_attributes.build], local: true) do |f| %>
  <%= f.label :name, "Attribute Name" %>
  <%= f.text_field :name, id: "attribute_name" %>

  <%= f.label :field_type, "Attribute Type" %>
  <%= f.select :field_type, options_for_select([['Text', 'text_input'], ['MCQ', 'mcq'], ['Scale', 'scale']]), {}, { id: "attribute_type", onchange: 'toggleFields(this.value)' } %>

  <%# Scale fields %>
  <div id="scale_fields" style="display: none;">
    <%= f.label :min_value, "Minimum Value" %>
    <%= f.number_field :min_value %>

    <%= f.label :max_value, "Maximum Value" %>
    <%= f.number_field :max_value %>
  </div>

  <%# MCQ fields %>
  <div id="mcq_fields" style="display: none;">
    <%= f.label :options, "MCQ Options" %>
    <div id="mcq_options_container">
      <input type="text" name="mcq_options[]" placeholder="Option 1" class="form-control" />
      <input type="text" name="mcq_options[]" placeholder="Option 2" class="form-control" />
    </div>
    <button type="button" class="btn btn-secondary" id="add_option_button">Add Option</button>
  </div>

  <%= f.submit "Save Attribute", class: "btn btn-primary" %>
<% end %>

<%= render 'preview' %>

<% unless Rails.env.test? %>
  <script>
    function toggleFields(fieldType) {
      document.getElementById('scale_fields').style.display = fieldType === 'scale' ? 'block' : 'none';
      document.getElementById('mcq_fields').style.display = fieldType === 'mcq' ? 'block' : 'none';
    }

    document.getElementById('add_option_button').addEventListener('click', function() {
      var container = document.getElementById('mcq_options_container');
      var optionCount = container.getElementsByClassName('form-control').length + 1;

      var newOptionInput = document.createElement('input');
      newOptionInput.type = 'text';
      newOptionInput.name = 'mcq_options[]';
      newOptionInput.placeholder = 'Option ' + optionCount;
      newOptionInput.classList.add('form-control');

      container.appendChild(newOptionInput);
    });

    function setDeadline() {
      var deadlinePicker = document.getElementById("deadline_picker");
      var selectedDeadline = deadlinePicker.value;

      if (selectedDeadline) {
        var date = new Date(selectedDeadline);
        var displayDeadline = document.getElementById("display_deadline");
        displayDeadline.innerText = "Selected Deadline: " + 
          date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            hour12: true,
            timeZoneName: 'short'
          }).replace(',', ' at');
        
        // Display deadline temporarily for 5 seconds
        displayDeadline.style.display = 'block';
        setTimeout(function() {
          displayDeadline.style.display = 'none';
        }, 5000);
      } else {
        document.getElementById("display_deadline").innerText = "Please select a deadline.";
      }
    }

    document.getElementById('form_submit_button').addEventListener('click', function(event) {
      var deadlinePicker = document.getElementById('deadline_picker');
      var selectedDeadline = new Date(deadlinePicker.value);
      var now = new Date();

      if (selectedDeadline < now) {
        alert("The deadline cannot be in the past.");
        event.preventDefault();
      }
    });
  </script>
<% end %>
